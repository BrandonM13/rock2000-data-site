<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rock 2000 – Artist Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> th, td { border-bottom: 1px solid #eee; } </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-2">Rock 2000 – Artist Search</h1>
    <p class="text-sm text-gray-600 mb-4">Exact match only (for now). Reads from your Google Sheet via GViz JSON.</p>

    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex flex-col md:flex-row gap-3 items-end">
        <div class="flex-1">
          <label class="block text-sm mb-1">Artist</label>
          <input id="artistName" class="w-full border rounded px-3 py-2" placeholder="e.g., IRON MAIDEN" />
        </div>
        <button id="artistBtn" class="rounded-2xl px-4 py-2 bg-black text-white">Search</button>
      </div>
      <div id="status" class="mt-3 text-xs text-gray-500">Loading…</div>
      <div id="artistSummary" class="mt-4 text-sm"></div>
      <div id="artistTable" class="mt-4 text-sm"></div>
    </section>
  </main>

  <script>
    // ===== CONFIG =====
    const SHEET_ID = "1xlSqIR-ZjTaZB5Ghn4UmoryKxdcjyvFUKfCqI299fnE"; // your sheet
    const TAB_MCD = "MasterCountdownData"; // tall table: YEAR, RANK, KEY = SONG|ARTIST, SONGS, ARTISTS

    // Header synonyms (case-insensitive; includes plurals and special KEY header)
    const EXPECTED = {
      year:   ["year", "yr"],
      rank:   ["rank", "position"],
      song:   ["songs", "song", "title", "song_title", "all_caps_title", "all caps title"],
      artist: ["artists", "artist", "artist_name", "all_caps_artist", "all caps artist"],
      key:    ["key", "master_key", "key = song|artist", "song|artist", "song_artist_key"],
    };

    // ===== Helpers =====
    function norm(s){
      return (s||"").toString().normalize("NFKD").toUpperCase().replace(/&/g,"AND").replace(/["'`]/g,"").replace(/\s+/g," ").trim();
    }
    async function fetchSheet(sheetName){
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => (c.label || c.id || "").toString().trim());
      const rows = (json.table.rows||[]).map(r => (r.c||[]).map(c => c? c.v: ""));
      return { cols, rows };
    }
    function findHeader(cols, candidates){
      const lower = cols.map(c=>c.toString().trim().toLowerCase());
      for(const cand of candidates){ const i = lower.indexOf(cand); if(i!==-1) return i; }
      return -1;
    }

    // ===== Data =====
    let ARTIST_INDEX = new Map(); // artist -> { songs: Map(song -> {years: Map(year->rank)}) }
    let ALL_YEARS = new Set();

    async function load(){
      const status = document.getElementById('status');
      status.textContent = 'Loading MasterCountdownData…';
      const { cols, rows } = await fetchSheet(TAB_MCD);

      const iYear = findHeader(cols, EXPECTED.year);
      const iRank = findHeader(cols, EXPECTED.rank);
      const iKey  = findHeader(cols, EXPECTED.key);
      const iSong = findHeader(cols, EXPECTED.song);
      const iArt  = findHeader(cols, EXPECTED.artist);

      if(iYear===-1 || iRank===-1 || (iKey===-1 && (iSong===-1 || iArt===-1)) ){
        status.textContent = `Could not find headers. Detected: [${cols.join(', ')}]`;
        throw new Error('Header mapping failed');
      }

      ARTIST_INDEX.clear();
      ALL_YEARS = new Set();

      for(const r of rows){
        const year = r[iYear];
        const rank = r[iRank];
        if(year==="" || rank==="") continue;
        ALL_YEARS.add(Number(year));

        let song = iSong!==-1 ? r[iSong] : "";
        let artist = iArt!==-1 ? r[iArt] : "";
        if((!song || !artist) && iKey!==-1 && r[iKey]){
          const parts = String(r[iKey]).split('|');
          song = song || (parts[0]||"");
          artist = artist || (parts[1]||"");
        }
        if(!(song||artist)) continue;

        const aKey = norm(artist);
        const sKey = norm(song);
        if(!ARTIST_INDEX.has(aKey)) ARTIST_INDEX.set(aKey, { songs: new Map() });
        const bucket = ARTIST_INDEX.get(aKey);
        if(!bucket.songs.has(sKey)) bucket.songs.set(sKey, { song, years: new Map() });
        const sRec = bucket.songs.get(sKey);
        sRec.years.set(Number(year), Number(rank));
      }

      const yrs = Array.from(ALL_YEARS).sort((a,b)=>a-b);
      status.textContent = `Loaded ${rows.length} rows · Years ${yrs[0]}–${yrs[yrs.length-1]} · Artists: ${ARTIST_INDEX.size}`;
    }

    function enrichSongRecord(sRec){
      const years = Array.from(sRec.years.keys()).sort((a,b)=>a-b);
      const ranks = years.map(y=>sRec.years.get(y));
      const best = Math.min(...ranks);
      const avg = Math.round(ranks.reduce((a,b)=>a+b,0)/ranks.length);
      let change = "";
      if(years.length>=2){
        const curr = sRec.years.get(years[years.length-1]);
        const prev = sRec.years.get(years[years.length-2]);
        if(curr!=null && prev!=null) change = prev - curr; // positive = improved
      }
      return { years, best, avg, change };
    }

    function renderArtist(artistRaw){
      const artist = norm(artistRaw);
      const mountSummary = document.getElementById('artistSummary');
      const mountTable = document.getElementById('artistTable');
      mountSummary.innerHTML = '';
      mountTable.innerHTML = '';

      const data = ARTIST_INDEX.get(artist);
      if(!data){
        mountSummary.innerHTML = `<div class="text-gray-500">No matches for <strong>${artistRaw}</strong></div>`;
        return;
      }

      const yearsAll = Array.from(ALL_YEARS).sort((a,b)=>b-a); // descending
      const songs = Array.from(data.songs.values()).sort((a,b)=> a.song.localeCompare(b.song));

      mountSummary.innerHTML = `Total songs: <strong>${songs.length}</strong>`;

      const hdrYears = yearsAll.map(y=>`<th class="px-2 py-1 text-right">${y}</th>`).join('');
      const thead = `
        <thead class="bg-gray-100 sticky top-0">
          <tr>
            <th class="text-left px-2 py-1">Song</th>
            <th class="text-right px-2 py-1">Best</th>
            <th class="text-right px-2 py-1">Avg</th>
            <th class="text-right px-2 py-1">Change*</th>
            ${hdrYears}
          </tr>
        </thead>`;

      const rowsHtml = songs.map(sRec => {
        const { best, avg, change } = enrichSongRecord(sRec);
        const cellsYears = yearsAll.map(y => {
          const v = sRec.years.get(y);
          return `<td class="px-2 py-1 text-right">${v==null?'-':v}</td>`;
        }).join('');
        return `<tr>
          <td class="px-2 py-1">${sRec.song}</td>
          <td class="px-2 py-1 text-right">${best}</td>
          <td class="px-2 py-1 text-right">${avg}</td>
          <td class="px-2 py-1 text-right">${change!==''?change:'-'}</td>
          ${cellsYears}
        </tr>`;
      }).join('');

      mountTable.innerHTML = `
        <div class="overflow-auto border rounded">
          <table class="text-xs w-[1200px] min-w-full">
            ${thead}
            <tbody>${rowsHtml}</tbody>
          </table>
        </div>
        <div class="text-[11px] text-gray-500 mt-2">*Change = previous year rank − latest year rank (positive means improvement).</div>
      `;
    }

    (async function(){
      try { await load(); }
      catch (e){
        console.error(e);
        document.getElementById('status').textContent = 'Failed to load. Check Publish-to-web + Anyone-viewer + tab names.';
        return;
      }
      document.getElementById('status').textContent = 'Ready.';
      document.getElementById('artistBtn').onclick = () => {
        const a = document.getElementById('artistName').value;
        renderArtist(a);
      };
    })();
  </script>
</body>
</html>
